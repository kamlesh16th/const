<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Construction Cost Estimator - Detailed</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- jsPDF & autoTable -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

    <style>
        body { background:#f5f7fa; padding:1rem; font-size:0.95rem; }
        .container { max-width:1400px; }
        .table { font-size:0.9rem; }
        .table th { 
            background:#0d6efd; 
            color:white; 
            position:sticky; 
            top:0; 
            z-index:10; 
        }
        .subtotal { font-weight:600; color:#2c7be5; }
        .grand-total { 
            font-size:1.3rem; 
            font-weight:bold; 
            padding:1rem; 
            background:linear-gradient(135deg,#e3f2fd,#bbdefb); 
            border-radius:10px; 
            margin:1.5rem 0; 
        }

        @media (max-width:768px) {
            .table thead { display:none; }
            .table tr { 
                display:block; 
                margin-bottom:1.2rem; 
                border:1px solid #dee2e6; 
                border-radius:8px; 
                background:white; 
                box-shadow:0 2px 6px rgba(0,0,0,0.08);
            }
            .table td { 
                display:flex; 
                justify-content:space-between; 
                border:none; 
                padding:0.7rem 1rem; 
                border-bottom:1px solid #eee;
            }
            .table td:before { 
                content:attr(data-label); 
                font-weight:bold; 
                width:45%; 
                color:#495057;
            }
        }
    </style>
</head>
<body>

<div class="container">
    <h2 class="text-center mb-4 fw-bold text-primary">Construction Cost Estimator</h2>

    <div class="d-flex flex-wrap gap-2 mb-4 justify-content-center justify-content-sm-between">
        <button class="btn btn-primary btn-sm" onclick="addRow()">+ Add Custom Item</button>
        
        <div class="d-flex flex-wrap gap-2">
            <button class="btn btn-success btn-sm" onclick="printTable()">Print</button>
            <button class="btn btn-info btn-sm" onclick="exportToPDF()">Export PDF</button>
            <button class="btn btn-warning btn-sm" onclick="downloadCSV()">CSV ↓</button>
            <label class="btn btn-secondary btn-sm mb-0">
                CSV ↑ <input type="file" id="uploadCSV" accept=".csv" hidden onchange="uploadCSVFile(this)">
            </label>
        </div>
    </div>

    <div class="table-responsive">
        <table class="table table-hover table-bordered" id="estimatorTable">
            <thead>
                <tr>
                    <th>Description</th>
                    <th>Qty / Area (sq.ft)</th>
                    <th>Rate (₹)</th>
                    <th>Subtotal (₹)</th>
                    <th>Remarks</th>
                    <th class="text-center">Action</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td data-label="Description"><input type="text" class="form-control" value="Foundation"></td>
                    <td data-label="Qty / Area"><input type="number" class="form-control qty" value="0" min="0" step="0.01" oninput="calc(this)"></td>
                    <td data-label="Rate"><input type="number" class="form-control rate" value="0" min="0" step="0.01" oninput="calc(this)"></td>
                    <td data-label="Subtotal" class="subtotal text-end">0</td>
                    <td data-label="Remarks"><input type="text" class="form-control"></td>
                    <td data-label="Action" class="text-center"><button class="btn btn-danger btn-sm" onclick="removeRow(this)">×</button></td>
                </tr>
                <tr>
                    <td data-label="Description"><input type="text" class="form-control" value="Plinth"></td>
                    <td data-label="Qty / Area"><input type="number" class="form-control qty" value="0" min="0" step="0.01" oninput="calc(this)"></td>
                    <td data-label="Rate"><input type="number" class="form-control rate" value="0" min="0" step="0.01" oninput="calc(this)"></td>
                    <td data-label="Subtotal" class="subtotal text-end">0</td>
                    <td data-label="Remarks"><input type="text" class="form-control"></td>
                    <td data-label="Action" class="text-center"><button class="btn btn-danger btn-sm" onclick="removeRow(this)">×</button></td>
                </tr>
                <tr>
                    <td data-label="Description"><input type="text" class="form-control" value="Beams & Lintels"></td>
                    <td data-label="Qty / Area"><input type="number" class="form-control qty" value="0" min="0" oninput="calc(this)"></td>
                    <td data-label="Rate"><input type="number" class="form-control rate" value="0" min="0" oninput="calc(this)"></td>
                    <td data-label="Subtotal" class="subtotal text-end">0</td>
                    <td data-label="Remarks"><input type="text" class="form-control"></td>
                    <td data-label="Action" class="text-center"><button class="btn btn-danger btn-sm" onclick="removeRow(this)">×</button></td>
                </tr>
                <tr>
                    <td data-label="Description"><input type="text" class="form-control" value="Columns"></td>
                    <td data-label="Qty / Area"><input type="number" class="form-control qty" value="0" min="0" oninput="calc(this)"></td>
                    <td data-label="Rate"><input type="number" class="form-control rate" value="0" min="0" oninput="calc(this)"></td>
                    <td data-label="Subtotal" class="subtotal text-end">0</td>
                    <td data-label="Remarks"><input type="text" class="form-control"></td>
                    <td data-label="Action" class="text-center"><button class="btn btn-danger btn-sm" onclick="removeRow(this)">×</button></td>
                </tr>
                <tr>
                    <td data-label="Description"><input type="text" class="form-control" value="Ground Floor"></td>
                    <td data-label="Qty / Area"><input type="number" class="form-control qty" value="0" min="0" oninput="calc(this)"></td>
                    <td data-label="Rate"><input type="number" class="form-control rate" value="0" min="0" oninput="calc(this)"></td>
                    <td data-label="Subtotal" class="subtotal text-end">0</td>
                    <td data-label="Remarks"><input type="text" class="form-control"></td>
                    <td data-label="Action" class="text-center"><button class="btn btn-danger btn-sm" onclick="removeRow(this)">×</button></td>
                </tr>
                <tr>
                    <td data-label="Description"><input type="text" class="form-control" value="First Floor"></td>
                    <td data-label="Qty / Area"><input type="number" class="form-control qty" value="0" min="0" oninput="calc(this)"></td>
                    <td data-label="Rate"><input type="number" class="form-control rate" value="0" min="0" oninput="calc(this)"></td>
                    <td data-label="Subtotal" class="subtotal text-end">0</td>
                    <td data-label="Remarks"><input type="text" class="form-control"></td>
                    <td data-label="Action" class="text-center"><button class="btn btn-danger btn-sm" onclick="removeRow(this)">×</button></td>
                </tr>
                <tr>
                    <td data-label="Description"><input type="text" class="form-control" value="Second Floor"></td>
                    <td data-label="Qty / Area"><input type="number" class="form-control qty" value="0" min="0" oninput="calc(this)"></td>
                    <td data-label="Rate"><input type="number" class="form-control rate" value="0" min="0" oninput="calc(this)"></td>
                    <td data-label="Subtotal" class="subtotal text-end">0</td>
                    <td data-label="Remarks"><input type="text" class="form-control"></td>
                    <td data-label="Action" class="text-center"><button class="btn btn-danger btn-sm" onclick="removeRow(this)">×</button></td>
                </tr>
                <tr>
                    <td data-label="Description"><input type="text" class="form-control" value="Third Floor"></td>
                    <td data-label="Qty / Area"><input type="number" class="form-control qty" value="0" min="0" oninput="calc(this)"></td>
                    <td data-label="Rate"><input type="number" class="form-control rate" value="0" min="0" oninput="calc(this)"></td>
                    <td data-label="Subtotal" class="subtotal text-end">0</td>
                    <td data-label="Remarks"><input type="text" class="form-control"></td>
                    <td data-label="Action" class="text-center"><button class="btn btn-danger btn-sm" onclick="removeRow(this)">×</button></td>
                </tr>
                <tr>
                    <td data-label="Description"><input type="text" class="form-control" value="Roof / Terrace Slab"></td>
                    <td data-label="Qty / Area"><input type="number" class="form-control qty" value="0" min="0" oninput="calc(this)"></td>
                    <td data-label="Rate"><input type="number" class="form-control rate" value="0" min="0" oninput="calc(this)"></td>
                    <td data-label="Subtotal" class="subtotal text-end">0</td>
                    <td data-label="Remarks"><input type="text" class="form-control"></td>
                    <td data-label="Action" class="text-center"><button class="btn btn-danger btn-sm" onclick="removeRow(this)">×</button></td>
                </tr>
                <tr>
                    <td data-label="Description"><input type="text" class="form-control" value="Parapet"></td>
                    <td data-label="Qty / Area"><input type="number" class="form-control qty" value="0" min="0" oninput="calc(this)"></td>
                    <td data-label="Rate"><input type="number" class="form-control rate" value="0" min="0" oninput="calc(this)"></td>
                    <td data-label="Subtotal" class="subtotal text-end">0</td>
                    <td data-label="Remarks"><input type="text" class="form-control"></td>
                    <td data-label="Action" class="text-center"><button class="btn btn-danger btn-sm" onclick="removeRow(this)">×</button></td>
                </tr>
                <tr>
                    <td data-label="Description"><input type="text" class="form-control" value="Staircase 1"></td>
                    <td data-label="Qty / Area"><input type="number" class="form-control qty" value="0" min="0" oninput="calc(this)"></td>
                    <td data-label="Rate"><input type="number" class="form-control rate" value="0" min="0" oninput="calc(this)"></td>
                    <td data-label="Subtotal" class="subtotal text-end">0</td>
                    <td data-label="Remarks"><input type="text" class="form-control"></td>
                    <td data-label="Action" class="text-center"><button class="btn btn-danger btn-sm" onclick="removeRow(this)">×</button></td>
                </tr>
                <tr>
                    <td data-label="Description"><input type="text" class="form-control" value="Staircase 2"></td>
                    <td data-label="Qty / Area"><input type="number" class="form-control qty" value="0" min="0" oninput="calc(this)"></td>
                    <td data-label="Rate"><input type="number" class="form-control rate" value="0" min="0" oninput="calc(this)"></td>
                    <td data-label="Subtotal" class="subtotal text-end">0</td>
                    <td data-label="Remarks"><input type="text" class="form-control"></td>
                    <td data-label="Action" class="text-center"><button class="btn btn-danger btn-sm" onclick="removeRow(this)">×</button></td>
                </tr>
                <tr>
                    <td data-label="Description"><input type="text" class="form-control" value="Exterior Design / Elevation"></td>
                    <td data-label="Qty / Area"><input type="number" class="form-control qty" value="0" min="0" oninput="calc(this)"></td>
                    <td data-label="Rate"><input type="number" class="form-control rate" value="0" min="0" oninput="calc(this)"></td>
                    <td data-label="Subtotal" class="subtotal text-end">0</td>
                    <td data-label="Remarks"><input type="text" class="form-control"></td>
                    <td data-label="Action" class="text-center"><button class="btn btn-danger btn-sm" onclick="removeRow(this)">×</button></td>
                </tr>
                <tr>
                    <td data-label="Description"><input type="text" class="form-control" value="Boundary Wall / Compound Wall"></td>
                    <td data-label="Qty / Area"><input type="number" class="form-control qty" value="0" min="0" oninput="calc(this)"></td>
                    <td data-label="Rate"><input type="number" class="form-control rate" value="0" min="0" oninput="calc(this)"></td>
                    <td data-label="Subtotal" class="subtotal text-end">0</td>
                    <td data-label="Remarks"><input type="text" class="form-control"></td>
                    <td data-label="Action" class="text-center"><button class="btn btn-danger btn-sm" onclick="removeRow(this)">×</button></td>
                </tr>
                <tr>
                    <td data-label="Description"><input type="text" class="form-control" value="Painting (Internal + External)"></td>
                    <td data-label="Qty / Area"><input type="number" class="form-control qty" value="0" min="0" oninput="calc(this)"></td>
                    <td data-label="Rate"><input type="number" class="form-control rate" value="0" min="0" oninput="calc(this)"></td>
                    <td data-label="Subtotal" class="subtotal text-end">0</td>
                    <td data-label="Remarks"><input type="text" class="form-control"></td>
                    <td data-label="Action" class="text-center"><button class="btn btn-danger btn-sm" onclick="removeRow(this)">×</button></td>
                </tr>
                <tr>
                    <td data-label="Description"><input type="text" class="form-control" value="Electrical Work"></td>
                    <td data-label="Qty / Area"><input type="number" class="form-control qty" value="0" min="0" oninput="calc(this)"></td>
                    <td data-label="Rate"><input type="number" class="form-control rate" value="0" min="0" oninput="calc(this)"></td>
                    <td data-label="Subtotal" class="subtotal text-end">0</td>
                    <td data-label="Remarks"><input type="text" class="form-control"></td>
                    <td data-label="Action" class="text-center"><button class="btn btn-danger btn-sm" onclick="removeRow(this)">×</button></td>
                </tr>
                <tr>
                    <td data-label="Description"><input type="text" class="form-control" value="Plumbing & Sanitary"></td>
                    <td data-label="Qty / Area"><input type="number" class="form-control qty" value="0" min="0" oninput="calc(this)"></td>
                    <td data-label="Rate"><input type="number" class="form-control rate" value="0" min="0" oninput="calc(this)"></td>
                    <td data-label="Subtotal" class="subtotal text-end">0</td>
                    <td data-label="Remarks"><input type="text" class="form-control"></td>
                    <td data-label="Action" class="text-center"><button class="btn btn-danger btn-sm" onclick="removeRow(this)">×</button></td>
                </tr>
            </tbody>
        </table>
    </div>

    <div class="grand-total text-center" id="grandTotal">
        Grand Total: ₹ 0.00
    </div>
</div>

<script>
// ─── Calculation Functions ───────────────────────────────────────
function calc(input) {
    const row = input.closest('tr');
    const qty = Number(row.querySelector('.qty').value) || 0;
    const rate = Number(row.querySelector('.rate').value) || 0;
    const subtotal = qty * rate;
    row.querySelector('.subtotal').textContent = subtotal.toLocaleString('en-IN', {
        minimumFractionDigits:2, 
        maximumFractionDigits:2
    });
    updateGrandTotal();
}

function updateGrandTotal() {
    let sum = 0;
    document.querySelectorAll('.subtotal').forEach(el => {
        sum += parseFloat(el.textContent.replace(/,/g, '')) || 0;
    });
    document.getElementById('grandTotal').textContent = 
        `Grand Total: ₹ ${sum.toLocaleString('en-IN', {minimumFractionDigits:2, maximumFractionDigits:2})}`;
}

// ─── Row Management ──────────────────────────────────────────────
function addRow() {
    const tbody = document.querySelector('#estimatorTable tbody');
    const row = document.createElement('tr');
    row.innerHTML = `
        <td data-label="Description"><input type="text" class="form-control" value="Custom Item"></td>
        <td data-label="Qty / Area"><input type="number" class="form-control qty" value="0" min="0" step="0.01" oninput="calc(this)"></td>
        <td data-label="Rate"><input type="number" class="form-control rate" value="0" min="0" step="0.01" oninput="calc(this)"></td>
        <td data-label="Subtotal" class="subtotal text-end">0</td>
        <td data-label="Remarks"><input type="text" class="form-control"></td>
        <td data-label="Action" class="text-center"><button class="btn btn-danger btn-sm" onclick="removeRow(this)">×</button></td>
    `;
    tbody.appendChild(row);
}

function removeRow(btn) {
    btn.closest('tr').remove();
    updateGrandTotal();
}

function printTable() {
    window.print();
}

// ─── PDF Export (beautiful formatting) ───────────────────────────
function exportToPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ orientation: 'portrait', unit: 'mm', format: 'a4' });

    // Header
    doc.setFillColor(13, 110, 253);
    doc.rect(0, 0, 210, 40, 'F');
    doc.setFontSize(20);
    doc.setTextColor(255);
    doc.setFont("helvetica", "bold");
    doc.text("Construction Cost Estimate", 105, 22, { align: "center" });
    
    doc.setFontSize(11);
    doc.setTextColor(240,240,240);
    doc.text("Generated: " + new Date().toLocaleDateString('en-IN'), 105, 30, { align: "center" });

    // Table Data
    const tableData = [];
    document.querySelectorAll('#estimatorTable tbody tr').forEach(row => {
        const cells = row.querySelectorAll('td');
        tableData.push([
            cells[0].querySelector('input').value || '',
            cells[1].querySelector('input').value || '0',
            cells[2].querySelector('input').value || '0',
            cells[3].textContent || '0',
            cells[4].querySelector('input').value || ''
        ]);
    });

    const grandTotal = document.getElementById('grandTotal').textContent;

    doc.autoTable({
        startY: 48,
        head: [['Description', 'Qty / Area (sq.ft)', 'Rate (₹)', 'Subtotal (₹)', 'Remarks']],
        body: tableData,
        theme: 'grid',
        styles: { fontSize: 9, cellPadding: 4, textColor: [33,37,41], lineColor: [44,62,80], lineWidth: 0.1 },
        headStyles: { fillColor: [13,110,253], textColor: 255, fontSize: 10, fontStyle: 'bold' },
        alternateRowStyles: { fillColor: [245,247,250] },
        columnStyles: {
            0: { cellWidth: 60 },
            1: { cellWidth: 35, halign: 'right' },
            2: { cellWidth: 35, halign: 'right' },
            3: { cellWidth: 35, halign: 'right', fontStyle: 'bold' },
            4: { cellWidth: 25 }
        },
        margin: { top: 48, left: 10, right: 10 }
    });

    // Grand Total
    const finalY = doc.lastAutoTable.finalY + 12;
    doc.setFillColor(187, 222, 251);
    doc.rect(10, finalY - 4, 190, 14, 'F');
    doc.setFontSize(13);
    doc.setTextColor(0,51,102);
    doc.setFont("helvetica", "bold");
    doc.text(grandTotal, 190, finalY + 4, { align: "right" });

    // Footer
    doc.setFontSize(8);
    doc.setTextColor(100);
    doc.text("Generated with Construction Cost Estimator • For personal use", 105, 290, { align: "center" });

    doc.save('Construction_Estimate_' + new Date().toISOString().slice(0,10) + '.pdf');
}

// CSV functions (same as before)
function downloadCSV() {
    const rows = [['Description','Qty/Area','Rate','Subtotal','Remarks']];
    document.querySelectorAll('#estimatorTable tbody tr').forEach(tr => {
        const tds = tr.querySelectorAll('td');
        rows.push([
            tds[0].querySelector('input').value,
            tds[1].querySelector('input').value,
            tds[2].querySelector('input').value,
            tds[3].textContent,
            tds[4].querySelector('input').value
        ]);
    });
    const csv = Papa.unparse(rows);
    const blob = new Blob([csv], {type: 'text/csv;charset=utf-8;'});
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = 'construction_estimate.csv';
    link.click();
}

function uploadCSVFile(input) {
    const file = input.files[0];
    if (!file) return;

    Papa.parse(file, {
        complete: function(results) {
            const tbody = document.querySelector('#estimatorTable tbody');
            tbody.innerHTML = '';
            results.data.slice(1).forEach(row => {
                if (row.length < 5) return;
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td data-label="Description"><input type="text" class="form-control" value="${row[0]}"></td>
                    <td data-label="Qty / Area"><input type="number" class="form-control qty" value="${row[1]}" min="0" oninput="calc(this)"></td>
                    <td data-label="Rate"><input type="number" class="form-control rate" value="${row[2]}" min="0" oninput="calc(this)"></td>
                    <td data-label="Subtotal" class="subtotal text-end">${row[3]}</td>
                    <td data-label="Remarks"><input type="text" class="form-control" value="${row[4]}"></td>
                    <td data-label="Action" class="text-center"><button class="btn btn-danger btn-sm" onclick="removeRow(this)">×</button></td>
                `;
                tbody.appendChild(tr);
            });
            updateGrandTotal();
        }
    });
}

// Initialize
document.querySelectorAll('.qty, .rate').forEach(el => calc(el));
</script>
</body>
</html>
